# Common (node.js + browser)

These classes and functions are available via both `@transitive-sdk/utils` and `@transitive-sdk/utils-web`.<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

## DataCache

A class implementing a local data cache, used as a local data store with
deduplication detection and update events. While this class is very handy
you probably won't need to create instances of it directly. Instead use
the mqttSync.data instance which holds the locally stored data
subscribed/published from/to MQTTSync.
For example on the robot:

```js
// update/publish our status:
mqttSync.data.update('status', {changed: Date.now(), msg: 'OK'});
// subscribe to new user requests (e.g., from UI):
mqttSync.data.subscribePath('+user/request', (request, key, {user}) => {
  log.debug(`user ${user} made request`, request);
});
```

In the cloud or in a web component you would need to use the full topic including
org, device, scope, cap-name, and version.

#### Parameters

*   `data`   (optional, default `{}`)

### filter

Filter the object using path with wildcards

##### Parameters

*   `path` &#x20;

### filterByTopic

Filter the object using topic with wildcards

##### Parameters

*   `topic` &#x20;

### forMatch

For each topic match, invoke the callback with the value, path, and match
just like subscribePath, but on the current data rather than future changes.

##### Parameters

*   `topic` &#x20;
*   `callback` &#x20;

### forPathMatch

For each path match, invoke the callback with the value, path, and match
just like subscribePath

##### Parameters

*   `path` &#x20;
*   `callback` &#x20;

### get

Get sub-value at path, or entire object if none given

##### Parameters

*   `path`   (optional, default `[]`)

### getByTopic

Get sub-value specified by topic

##### Parameters

*   `topic` &#x20;

### subscribe

Add a callback for all change events.

##### Parameters

*   `callback` &#x20;

### subscribePath

Subscribe to a specific topic only. Callback receives
`value, key, matched, tags`. TODO: rename to subscribeTopic.

##### Parameters

*   `topic` &#x20;
*   `callback` &#x20;

### subscribePathFlat

Same as subscribePath but always get all changes in flat form

##### Parameters

*   `topic` &#x20;
*   `callback` &#x20;

### unsubscribe

Remove a callback previously registered using `subscribe`.

##### Parameters

*   `callback` &#x20;

### update

Update the value at the given path (array or dot separated string)

##### Parameters

*   `path` &#x20;
*   `value` &#x20;
*   `tags` &#x20;

### updateFromArray

Update the object with the given value at the given path, remove empty;
return the flat changes (see toFlatObject). Add `tags` to updates to mark
them somehow based on the context, e.g., so that some subscriptions can choose
to ignore updates with a certain tag.

##### Parameters

*   `path` &#x20;
*   `value` &#x20;
*   `tags`   (optional, default `{}`)

### updateFromModifier

Update data from a modifier object where keys are topic names to be
interpreted as paths, and values are the values to set

##### Parameters

*   `modifier` &#x20;
*   `tags` &#x20;

### updateFromTopic

Set value from the given topic (with or without leading or trailing slash)

##### Parameters

*   `topic` &#x20;
*   `value` &#x20;
*   `tags` &#x20;

## MqttSync

A class that combines DataCache and MQTT to implement a data synchronization
feature over the latter. Relies on retained messages in mqtt for persistence.

#### Parameters

*   `options` **[object][1]**&#x20;

    *   `options.mqttClient` **[object][1]** An already connected mqtt.js client.
    *   `options.onChange` **[function][2]?** A function that is called any time there
        is a change to the shared data. This is not usually used. It's usually better to
        use the finer grained `MqttSync.data.subscribePath` instead, that allows you to
        subscribe to changes just on a specific sun-object instead, see DataCache.
    *   `options.ignoreRetain` **[boolean][3]?** retain all messages, ignorant of the retain
        flag.
    *   `options.migrate` **[array][4]?** an array of objects of the form
        `{topic, newVersion, level}`. Only meaningful in the cloud. Instructs MQTTSync
        to first migrate existing topics to a new version namespace, publishing at the
        designated level down from the version level. For example:```js
        [{ topic: `/myorg/mydevice/@local/my-cap/+/config`,
        newVersion: this.version,
        level: 1
        }]
        ```Would migrate any existing data in the capability's `config` namespace to the
        current version of the package, publishing at the `config/+` level (rather than
        atomically at the config level itself).
    *   `options.onReady` **[function][2]?** A function that is called when the MQTTSync
        client is ready and has completed any requested migrations.
    *   `options.sliceTopic` **[number][5]?** a number indicating at what level to
        slice the topic, i.e., only use a suffix. Used in robot-capabilities to slice
        off the topic prefix (namespaces).
    *   `options.onHeartbeatGranted` &#x20;

### beforeDisconnect

Run all registered hooks before disconnecting

### call

Make an RPC request. Example:

```js
mqttSync.call('/mySquare', 11, result => {
  log.debug(`Called /mySquare with arg 11 and got ${result}`);
});
```

Alternative you can omit the callback and use async/await:

```js
const result = await mqttSync.call('/mySquare', 11);
log.debug(`Called /mySquare with arg 11 and got ${result}`);
```

See the note about namespaces in `register`.

Note: It is your responsibility to only call methods that exist (have been
registered). Calling a non-existent command just hangs.

##### Parameters

*   `command` &#x20;
*   `args` &#x20;
*   `callback`   (optional, default `undefined`)

### clear

Delete all retained messages in a certain topic prefix, waiting for
a mqtt broker heartbeat to collect existing retained. Use with care, never
delete topics not owned by us. Harmless within capabilities, which are
namespaced already.

`options.filter(topic)`: a function that can be provided to further,
programmatically filter the set of topics to clear, e.g., to onlt clear
topics of old versions.

Note: This may not yet work in robot-capabilities, since the subscription
prefix and received topic prefix don't match (the device prefix is added to
subscription by localMQTT.

##### Parameters

*   `prefixes` &#x20;
*   `callback`   (optional, default `undefined`)
*   `options`   (optional, default `{}`)

### clearThrottle

Clear the set throttling delay.

### isPublished

Check whether we are publishing the given topic in a non-atomic way.
This is used to determine whether to store the published value or not.

##### Parameters

*   `topic` &#x20;

### isSubscribed

check whether we are subscribed to the given topic

##### Parameters

*   `topic` &#x20;

### migrate

Migrate a list of `{topic, newVersion, transform}`. The version number in
topic will be ignored, and all versions' values will be merged, applied in
order, such that the latest version is applied last. `topic` may include
wildcards in the part before the version number but not after.

Example:

```js
mqttSync.migrate([{topic: '/+/dId/@scope/capname/+/b', newVersion: '1.2.0'}]
```

##### Parameters

*   `list` &#x20;
*   `onReady`   (optional, default `undefined`)

### onBeforeDisconnect

Register a new hook to be called before disconnecting

##### Parameters

*   `fn` &#x20;

### publish

Register a listener for path in data. Make sure to populate the data
before calling this or set the data all at once afterwards.

With option "atomic" this will always send the whole sub-document,
not flat changes. Useful, e.g., for desiredPackages, see
[https://github.com/chfritz/transitive/issues/85][6].

##### Parameters

*   `topic` &#x20;
*   `options`   (optional, default `{atomic:false}`)

Returns **any** true if publication added (false, e.g., when already present)

### publishAtLevel

Publish all values at the given level of the given object under the given
topic (plus sub-key, of course).
TODO: Is this OK, or do we need to go through this.publish?

##### Parameters

*   `topic` &#x20;
*   `value` &#x20;
*   `level` &#x20;

### register

Register an RPC request handler. Example:

```js
mqttSync.register('/mySquare', arg => {
  log.debug('running /mySquare with args', arg);
  return arg * arg;
});
```

Note that the command topic needs to be in the capabilities namespace like
any other topic. In robot capabilities, as usual, these can start in `/`
because the local mqtt bridge operated by the robot agent will place all
topics in their respective namespace. In the cloud and on the web you will
need to use the respective namespace, i.e.,
`/orgId/deviceId/@scope/capName/capVersion/`.

#### Async/Await

Yes, you can make the handler `async` and use `await` inside of it. This
will be handled correctly, i.e., MqttSync will await the result of the
handler before responding to the RPC request client.

##### Parameters

*   `command` &#x20;
*   `handler` &#x20;

### setThrottle

Set delay between processing of publishing queue in milliseconds. This
allows you to effectively throttle the rate at which this instance will
publish changes. Note that updates to a topic already in the queue will not
cause multiple publications. Only the latest value will be published.

##### Parameters

*   `delay` **[number][5]?** Number of milliseconds to wait between processing
    of publish queue.

### subscribe

Subscribe to the given topic (and all sub-topics). The callback will
indicate success/failure, *not* a message on the topic.

##### Parameters

*   `topic` &#x20;
*   `callback`   (optional, default `noop`)

### waitForHeartbeatOnce

register a callback for the next heartbeat from the broker

##### Parameters

*   `callback` &#x20;

## clone

Deep-clone the given object. All functionality is lost, just data is kept.

#### Parameters

*   `obj` &#x20;

## decodeJWT

Parse JWT and return the decoded payload (JSON).

#### Parameters

*   `jwt` &#x20;

## dropWildcardIds

reduce wildcards with Ids, such as `+sessionId`, to just +

#### Parameters

*   `x` &#x20;

## forMatchIterator

Iterate through the object and invoke callback for each match of path (with
named wildcards)

#### Parameters

*   `obj` &#x20;
*   `path` &#x20;
*   `callback` &#x20;
*   `pathSoFar`   (optional, default `[]`)
*   `matchSoFar`   (optional, default `{}`)

## getDateBase52

Get a base52 representation \[a-zA-Z] of the current date (ms since epoch)

## getLogger

Get a new loglevel logger; call with a name, e.g., `module.id`. The returned
logger has methods trace, debug, info, warn, error. See
[https://www.npmjs.com/package/loglevel][7] for details.

## getRandomId

Generate a random id (base36)

#### Parameters

*   `bytes`   (optional, default `6`)

## isPrefixOf

prefixArray is a prefix of the array

#### Parameters

*   `prefixArray` &#x20;
*   `array` &#x20;

## isSubTopicOf

sub is a strict sub-topic of parent, and in particular not equal

#### Parameters

*   `sub` &#x20;
*   `parent` &#x20;

## mergeVersions

given an object where the keys are versions, merge this into one object
where the latest version of each subfield overwrites any previous

#### Parameters

*   `versionsObject` &#x20;
*   `subTopic`   (optional, default `undefined`)
*   `options`   (optional, default `{}`)

## mqttClearRetained

delete all retained messages in a certain topic prefix, waiting for
a given delay to collect existing retained. Use with care, never delete topics
not owned by us. Harmless within capabilities, which are namespaced already.

#### Parameters

*   `mqttClient` &#x20;
*   `prefixes` &#x20;
*   `callback` &#x20;
*   `delay`   (optional, default `1000`)

## parseMQTTTopic

parse an MQTT topic according to our topic schema

#### Parameters

*   `topic` &#x20;

## parseMQTTUsername

parse usernames used in MQTT

#### Parameters

*   `username` &#x20;

## pathToTopic

convert a path array to mqtt topic; reduces +id identifiers to +

#### Parameters

*   `pathArray` &#x20;

## selectFromObject

Given an object and a path with wildcards (`*` and `+`), *modify* the object
to only contain elements matched by the path, e.g.,
`{a: {b: 1, c: 2}, d: 2}` and `['a','+']` would give `{a: {b: 1, c: 2}}`

#### Parameters

*   `obj` **[object][1]** The object to select from
*   `path` **[array][4]** An array specifying the path to select, potentially
    containing mqtt wildcards ('+').

## setFromPath

Like \_.set but without arrays. This allows using numbers as keys.

#### Parameters

*   `obj` &#x20;
*   `path` &#x20;
*   `value` &#x20;

## toBase52

Convert number to base52 \[a-zA-Z]

#### Parameters

*   `num` &#x20;

## toFlatObject

Given an object, return a new flat object of topic+value pairs, e.g.:

```js
{a: {b: 1, c: 2}, d: 3}   →   {'/a/b': 1, '/a/c': 2, '/d': 3}
```

Note: not idempotent!

```js
{'/a/b': 1, '/a/c': 2, d: 3}  →  {'%2Fa%2Fb': 1, '%2Fa%2Fc': 2, '/d': 3}
```

#### Parameters

*   `obj` &#x20;
*   `prefix`   (optional, default `[]`)
*   `rtv`   (optional, default `{}`)

## topicMatch

match a slash-separated topic with a selector using +XYZ for (named)
wildcards. Return the matching result.

#### Parameters

*   `selector` &#x20;
*   `topic` &#x20;

## topicToPath

convert topic to path array

#### Parameters

*   `topic` &#x20;

## tryJSONParse

Try parsing JSON, return null if unsuccessful

#### Parameters

*   `string` &#x20;

## unset

Unset the topic in that obj, and clean up parent if empty, recursively.
Return the path to the removed node.

#### Parameters

*   `obj` &#x20;
*   `path` &#x20;

## updateObject

Given a modifier `{"a/b/c": "xyz"}` update the object `obj` such that
`obj.a.b.c = "xyz"`.

#### Parameters

*   `obj` &#x20;
*   `modifier` &#x20;

## versionCompare

Compare to version strings. Return -1 if a is lower than b,
0 if they are equal, and 1 otherwise. If either is not a complete version,
e.g., 2.0, interpret it as a range and use its minimum version for the
comparison. Hence, 2.0 < 2.0.1.

#### Parameters

*   `a` &#x20;
*   `b` &#x20;

## visit

Reusable visitor pattern: iteratively visits all nodes in the tree
described by `object`, where `childField` indicates the child-of predicate.

#### Parameters

*   `object` &#x20;
*   `childField` &#x20;
*   `visitor` &#x20;

## visitAncestor

Given an object and a path, visit each ancestor of the path

#### Parameters

*   `object` &#x20;
*   `path` &#x20;
*   `visitor` &#x20;
*   `prefix`   (optional, default `[]`)

## wait

Wait for delay ms, for use in async functions.

#### Parameters

*   `delay` &#x20;

[1]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object

[2]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Statements/function

[3]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean

[4]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array

[5]: https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number

[6]: https://github.com/chfritz/transitive/issues/85

[7]: https://www.npmjs.com/package/loglevel
